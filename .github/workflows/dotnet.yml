name: VS4Mac Extension

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-mac:

    runs-on: macos-11

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v3
      with:
        path: main

    - name: Checkout Meadow.CLI.Core side-by-side
      uses: actions/checkout@v3
      with:
        repository: WildernessLabs/Meadow.CLI
        path: Meadow.CLI
        ref: illinker-deploy

    - name: Set default Xamarin SDK versions
      run: |
        $VM_ASSETS/select-xamarin-sdk-v2.sh --mono=6.12 --mac=8.2

    - name: Setup .NET Core SDK 5.0.x and 6.0.x
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: |
          5.0.x
          6.0.x

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5

    - name: Buil and Package VS2019
      run: |
        chmod +x build_package_2019.sh
        ./build_package_2019.sh

    - name: Upload mpack Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: Meadow.Mac.2019.mpack
        path: 'main/VS4Mac_Meadow_Extension/bin/Release/net472/*.mpack'

  build-mac-2022:
    runs-on: macos-12

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v3
      with:
        path: main

    - name: Checkout Meadow.CLI.Core side-by-side
      uses: actions/checkout@v3
      with:
        repository: WildernessLabs/Meadow.CLI
        path: Meadow.CLI
        ref: illinker-deploy

    - name: Set default Xamarin SDK versions
      run: |
        $VM_ASSETS/select-xamarin-sdk-v2.sh --mono=6.12 --mac=8.2

    - name: Setup .NET Core 6.0.x
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: |
          6.0.x

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5

    - name: Buil and Package VS2022
      run: |
        chmod +x build_package_2022.sh
        ./build_package_2022.sh

    - name: Upload mpack Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: Meadow.Mac.2022.mpack
        path: 'main/VS4Mac_Meadow_Extension/bin/Release/net6.0/*.mpack'